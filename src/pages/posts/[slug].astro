---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection, render } from "astro:content";

export const getStaticPaths = async () => {
  const posts = await getCollection("posts");
  return posts.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }));
};

const { post } = Astro.props;
const { Content } = await render(post);

const formatDate = (d: Date): string => {
  return d.toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
};
---

<BaseLayout title={post.data.title} description={post.data.description}>
  <article class="animate-fade-in-up">
    <!-- Post header -->
    <header class="mb-8">
      <time class="text-xs font-mono text-ink-faint uppercase tracking-widest">
        {formatDate(post.data.date)}
      </time>
      <h1 class="font-display text-3xl sm:text-4xl font-bold text-ink mt-3 leading-tight">
        {post.data.title}
      </h1>
      <p class="mt-3 text-xl font-body text-ink-muted italic leading-relaxed">
        {post.data.description}
      </p>
      {post.data.tags && post.data.tags.length > 0 && (
        <div class="flex flex-wrap gap-2 mt-4">
          {post.data.tags.map((tag: string) => (
            <span class="text-xs font-mono text-ink-faint bg-paper-dark px-2 py-0.5 rounded">
              {tag}
            </span>
          ))}
        </div>
      )}
      <div class="mt-6 border-t border-rule"></div>
    </header>

    <!-- Post content -->
    <div class="prose">
      <Content />
    </div>

    <!-- Sources -->
    {post.data.sources && post.data.sources.length > 0 && (
      <footer class="mt-12 pt-8 border-t border-rule">
        <h2 class="font-display text-xl font-bold text-ink mb-4">Sources</h2>
        <ul class="space-y-3">
          {post.data.sources.map((source: { title: string; url: string; hn_url: string }) => (
            <li class="text-sm font-body">
              <a
                href={source.url}
                class="text-accent hover:text-accent-warm underline underline-offset-2 transition-colors"
                target="_blank"
                rel="noopener noreferrer"
              >
                {source.title}
              </a>
              <span class="text-ink-faint mx-2">&middot;</span>
              <a
                href={source.hn_url}
                class="text-ink-faint hover:text-accent font-mono text-xs transition-colors"
                target="_blank"
                rel="noopener noreferrer"
              >
                HN discussion
              </a>
            </li>
          ))}
        </ul>
      </footer>
    )}

    <!-- Back link -->
    <div class="mt-10 pt-6 border-t border-rule">
      <a
        href="/"
        class="text-sm font-mono text-ink-muted hover:text-accent transition-colors"
      >
        &larr; Back to all dispatches
      </a>
    </div>
  </article>
</BaseLayout>
